{{ define "article" }}
    <script>
        function showReplyComment(id, hId, rId, type) {
            var obj = document.getElementById(id);
            document.getElementById(hId).style.display = "block";
            document.getElementById(hId).style.height = document.body.clientHeight + "px";
            obj.style.display = "block";
            document.getElementById('reply_id').value = rId;
            document.getElementById('reply_type').value = type;
            document.getElementById('reply_comment_content').focus();
        }
        function hideReplyComment(id, hId) {
            document.getElementById(hId).style.display = "none";
            document.getElementById(id).style.display = "none";
        }
        function submitReplyComment(id, hId) {
            hideReplyComment(id, hId);
            document.getElementById("reply_form").submit();
        }
        function deleteComment(id) {
            var msg = confirm("Will you delete this comment?");
            if (msg) {
                document.getElementById("delete_id").value = id;
                document.getElementById("delete_form").submit();
            }
        }
    </script>
{{ if .LoginData.IsLogin }}
    {{ $user := index .LoginData.Users .LoginData.LoginId }}
    {{ if $user.Permissions.CreateComment }}
    <div id='hidebg' style='position: absolute; left: 0px; top: 0px; background-color: #000; width: 100%; filter: alpha(opacity=60); opacity: 0.6; z-index: 2;'></div>
    <div id='reply_comment' style='position: absolute; left: 30%; top: 200px; background-color: #fff; border: 1px solid black; display: none; z-index: 3;'>
        <form id='reply_form' action='article?id=` + id + `&do=reply_comment' method='POST'>
            <span><input id='reply_id' name='reply_id' readonly='readonly' style='display: none;' />
            <input id='reply_type' name='reply_type' readonly='readonly' style='display: none;' />
            <div style='display: inline-block; cursor: pointer;' onclick='hideReplyComment("reply_comment", "hidebg");'>X</div></span><br>
            <span>content:</span><br>
            <textarea id='reply_comment_content' name='reply_comment_content' style='resize: none; width: 320px; height: 160px;'></textarea><br>
            <div style='display: inline-block; background-color: blue; cursor: pointer;' onclick='submitReplyComment("reply_comment", "hidebg");'>submit</div>
        </form>
    </div>
    {{ end }}
    {{ if $user.Permissions.DeleteComment }}
    <div style='display: none;'>
        <form id='delete_form' action='article?id=` + id + `&do=delete_comment' method='POST'>
            <input id='delete_id' name='delete_id' readonly='readonly' />
        </form>
    </div>
    {{ end }}
{{ end }}
{{ if .LoginData.IsLogin }}
    {{ $user := index .LoginData.Users .LoginData.LoginId }}
    {{ if $user.Permissions.EditArticle }}
    <a href='create?do=edit&id={{ .ArticleData.ArticleId }}'>Edit</a>
    {{ end }}
{{ end }}
{{ range $k, $v := .ArticleData.ArticleDecode }}
    {{ if eq $v.Type "i" }}
    <img src='{{ $v.Value }}' /><br>
    {{ end }}
    {{ if eq $v.Type "f" }}
    <span>Attach file: <a href='{{ $v.Value }}'>{{ $v.Extra }}</a></span><br>
    {{ end }}
    {{ if eq $v.Type "c" }}
    <b>{{ index $v.Extra 0 }} code:</b><br>
        {{ range $ck, $cv := $v.Extra }}
            {{ if ne $ck 0 }}
    <p>{{ $cv }}</p>
            {{ end }}
        {{ end }}
    {{ end }}
    {{ if eq $v.Type "t" }}
        {{ range $tk, $tv := $v.Extra }}
    <p>{{ $tv }}</p>
        {{ end }}
    {{ end }}
{{ end }}
{{ if .LoginData.IsLogin }}
    {{ $user := index .LoginData.Users .LoginData.LoginId }}
    {{ if $user.Permissions.CreateComment }}
    <span><a id='main_comment_set' href='javascript:showReplyComment("reply_comment", "hidebg", "-1", "new");'>New comment</a></span><br>
    {{ end }}
{{ end }}
{{ range $tmp, $k := .CommentData.SortedKeysComments }}
    {{ $v := index $.CommentData.Comments $k }}
    {{ $be := eq $v.BelongsTo $.ArticleData.ArticleId }}
    {{ $re := eq $v.RepliesTo "-1" }}
    {{ if and $be $re }}
        {{ $author := index $.LoginData.Users $v.AuthorId }}
    <b>{{ $author.Name }}: {{ $v.Content }} - {{ $v.DateTime }}</b>
        {{ if $.LoginData.IsLogin }}
            {{ $user := index $.LoginData.Users $.LoginData.LoginId }}
            {{ if $user.Permissions.CreateComment }}
    <span> <a id='reply_{{ $k }}' href='javascript:showReplyComment("reply_comment", "hidebg", "{{ $k }}", "reply");'>Reply</a></span>
            {{ end }}
            {{ if $user.Permissions.DeleteComment }}
    <span> <a href='javascript:deleteComment({{ $k }});'>Delete</a></span>
            {{ end }}
        {{ end }}
    <br>
        {{ range $ttmp, $sk := $.CommentData.SortedKeysComments }}
            {{ $sub := index $.CommentData.Comments $sk }}
            {{ $rootId := index $.CommentData.RootComment $sk }}
            {{ if eq $rootId $k }}
                {{ $subAuthor := index $.LoginData.Users $sub.AuthorId }}
    <span>{{ $subAuthor.Name }}: {{ $sub.Content }} - {{ $sub.DateTime }}</span>
                {{ if $.LoginData.IsLogin }}
                    {{ $subUser := index $.LoginData.Users $.LoginData.LoginId }}
                    {{ if $subUser.Permissions.CreateComment }}
    <span> <a id='reply_{{ $sk }}' href='javascript:showReplyComment("reply_comment", "hidebg", "{{ $sk }}", "reply");'>Reply</a></span>
                    {{ end }}
                    {{ if $subUser.Permissions.DeleteComment }}
    <span> <a href='javascript:deleteComment({{ $sk }})'>Delete</a></span>
                    {{ end }}
                {{ end }}
    <br>
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}
{{ end }}
